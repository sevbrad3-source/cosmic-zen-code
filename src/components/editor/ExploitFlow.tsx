import { Check, Loader2, AlertCircle, ChevronRight } from "lucide-react";
import { useState, useEffect } from "react";

interface FlowStep {
  id: string;
  label: string;
  status: "pending" | "running" | "success" | "failed";
  duration?: number;
  details?: string;
}

const ExploitFlow = () => {
  const [currentStep, setCurrentStep] = useState(0);
  const [steps, setSteps] = useState<FlowStep[]>([
    { id: "recon", label: "Reconnaissance", status: "success", duration: 2.4, details: "Port scan completed - 3 open ports found" },
    { id: "vuln", label: "Vulnerability Analysis", status: "success", duration: 5.2, details: "SQL injection vulnerability detected" },
    { id: "weaponize", label: "Weaponization", status: "success", duration: 1.8, details: "Payload crafted successfully" },
    { id: "deliver", label: "Delivery", status: "running", details: "Sending exploit to target..." },
    { id: "exploit", label: "Exploitation", status: "pending" },
    { id: "install", label: "Installation", status: "pending" },
    { id: "c2", label: "Command & Control", status: "pending" },
    { id: "actions", label: "Actions on Objectives", status: "pending" },
  ]);

  useEffect(() => {
    const runningIndex = steps.findIndex(s => s.status === "running");
    if (runningIndex !== -1) {
      const timer = setTimeout(() => {
        setSteps(prev => prev.map((step, idx) => {
          if (idx === runningIndex) {
            return { 
              ...step, 
              status: "success", 
              duration: Math.random() * 3 + 1,
              details: getStepDetails(step.id)
            };
          } else if (idx === runningIndex + 1) {
            return { ...step, status: "running", details: getRunningDetails(step.id) };
          }
          return step;
        }));
        setCurrentStep(runningIndex + 1);
      }, 2000);
      return () => clearTimeout(timer);
    }
  }, [steps]);

  const getStepDetails = (id: string): string => {
    const details: Record<string, string> = {
      recon: "Port scan completed - 3 open ports found",
      vuln: "SQL injection vulnerability detected",
      weaponize: "Payload crafted successfully",
      deliver: "Exploit delivered successfully",
      exploit: "Remote code execution achieved",
      install: "Backdoor installed on target system",
      c2: "C2 channel established - beacon active",
      actions: "Privilege escalation completed"
    };
    return details[id] || "Step completed";
  };

  const getRunningDetails = (id: string): string => {
    const details: Record<string, string> = {
      recon: "Scanning target ports...",
      vuln: "Analyzing vulnerabilities...",
      weaponize: "Generating payload...",
      deliver: "Sending exploit to target...",
      exploit: "Executing remote code...",
      install: "Installing persistence mechanism...",
      c2: "Establishing command channel...",
      actions: "Escalating privileges..."
    };
    return details[id] || "Processing...";
  };

  const getStatusIcon = (status: FlowStep["status"]) => {
    switch (status) {
      case "success":
        return <Check className="w-4 h-4 text-green-500" />;
      case "running":
        return <Loader2 className="w-4 h-4 text-primary animate-spin" />;
      case "failed":
        return <AlertCircle className="w-4 h-4 text-red-500" />;
      default:
        return <div className="w-4 h-4 rounded-full border-2 border-border" />;
    }
  };

  const completedSteps = steps.filter(s => s.status === "success").length;
  const progress = (completedSteps / steps.length) * 100;

  return (
    <div className="h-full flex flex-col">
      {/* Progress bar */}
      <div className="p-3 border-b border-border">
        <div className="flex items-center justify-between mb-2">
          <span className="text-xs font-semibold text-text-primary">Exploit Chain Progress</span>
          <span className="text-xs text-text-muted">{completedSteps}/{steps.length}</span>
        </div>
        <div className="w-full h-2 bg-sidebar-hover rounded-full overflow-hidden">
          <div 
            className="h-full bg-primary transition-all duration-500"
            style={{ width: `${progress}%` }}
          />
        </div>
      </div>

      {/* Kill chain steps */}
      <div className="flex-1 overflow-y-auto scrollbar-thin p-3 space-y-2">
        {steps.map((step, idx) => (
          <div
            key={step.id}
            className={`
              relative p-3 rounded border transition-all
              ${step.status === "running" ? "border-primary bg-primary/5" :
                step.status === "success" ? "border-border bg-panel-bg" :
                step.status === "failed" ? "border-red-500 bg-red-500/5" :
                "border-border bg-sidebar-bg opacity-60"}
            `}
          >
            <div className="flex items-start gap-3">
              <div className="flex-shrink-0 mt-0.5">
                {getStatusIcon(step.status)}
              </div>
              <div className="flex-1 min-w-0">
                <div className="flex items-center justify-between mb-1">
                  <h4 className="text-sm font-medium text-text-primary">{step.label}</h4>
                  {step.duration && (
                    <span className="text-xs text-text-muted">{step.duration.toFixed(1)}s</span>
                  )}
                </div>
                {step.details && (
                  <p className="text-xs text-text-secondary">{step.details}</p>
                )}
              </div>
            </div>

            {/* Connection line to next step */}
            {idx < steps.length - 1 && (
              <div className="absolute left-5 top-full w-0.5 h-2 bg-border -translate-x-1/2" />
            )}
          </div>
        ))}
      </div>

      {/* Footer stats */}
      <div className="p-3 border-t border-border bg-sidebar-bg">
        <div className="grid grid-cols-3 gap-2 text-xs">
          <div>
            <div className="text-text-muted">Success Rate</div>
            <div className="text-green-500 font-semibold">
              {((completedSteps / (steps.filter(s => s.status !== "pending").length)) * 100 || 0).toFixed(0)}%
            </div>
          </div>
          <div>
            <div className="text-text-muted">Total Time</div>
            <div className="text-text-primary font-semibold">
              {steps.reduce((acc, s) => acc + (s.duration || 0), 0).toFixed(1)}s
            </div>
          </div>
          <div>
            <div className="text-text-muted">Status</div>
            <div className={`font-semibold ${
              steps.some(s => s.status === "running") ? "text-primary" :
              completedSteps === steps.length ? "text-green-500" :
              "text-text-muted"
            }`}>
              {steps.some(s => s.status === "running") ? "Running" :
               completedSteps === steps.length ? "Complete" :
               "Pending"}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ExploitFlow;
